{% extends "base.html" %}
{% block content %}
    <!-- Chat Box-->
    <div class="col-7 px-0">
        <div class="px-4 py-5 chat-box bg-white" id="chat-log">
            {% for message in data.messages %}
                {% if message.sender == request.user %}
                    <!-- Sender Message -->
                    <div class="media w-50 mb-3"><img src="https://bootstrapious.com/i/snippets/sn-chat/avatar.svg" alt="user" width="50" class="rounded-circle">
                        <div class="media-body ml-3">
                            <div class="bg-light rounded py-2 px-3 mb-2">
                                <p class="text-small mb-0 text-white">{{ message.content }}</p>
                                <p class="text-small mb-0 text-muted">{{ message.status }}</p>
                            </div>
                            <p class="small text-muted">{{ message.timestamp }}</p>
                        </div>
                    </div>
                {% else %}
                    <!-- Receiver Message -->
                    <div class="media w-50 ml-auto mb-3">
                        <div class="media-body">
                            <div class="bg-primary rounded py-2 px-3 mb-2">
                                <p class="text-small mb-0 text-white">{{ message.content }}</p>
                                <p class="text-small mb-0 text-muted">{{ message.status }}</p>
                            </div>
                            <p class="small text-muted">{{ message.timestamp }}</p>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- Typing area -->
        <form id="chat-form" class="bg-light">
            <div class="input-group">
                <input type="text" id="chat-message-input" placeholder="Type a message" aria-describedby="button-addon2" class="form-control rounded-0 border-0 py-4 bg-light">
                <div class="input-group-append">
                    <button id="chat-message-submit" type="submit" class="btn btn-link"> <i class="fa fa-paper-plane"></i></button>
                </div>
            </div>
        </form>
    </div>

    <script>
       const urlParams = new URLSearchParams(window.location.search);
const jwtToken = urlParams.get('access_token');
const roomName = '{{ data.room.name }}';  // Make sure this is properly populated
const userId = urlParams.get('user_id');

console.log("roomName: ", roomName);
console.log("jwtToken: ", jwtToken);
console.log("userId: ", userId);

// Create the WebSocket instance
const socket = new WebSocket(`http://139.162.189.203:8001/ws/private/${roomName}/?access_token=${jwtToken}&user_id=${userId}`);

// Define WebSocket event handlers
socket.onopen = function(event) {
    console.log("WebSocket connection opened");
};

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const chatLog = document.getElementById('chat-log');
    const messageElement = document.createElement('div');

    const senderClass = data.sender === userId ? 'media w-50 mb-3' : 'media w-50 ml-auto mb-3';
    const bgClass = data.sender === userId ? 'bg-light' : 'bg-primary';
    const textClass = data.sender === userId ? 'text-muted' : 'text-white';

    messageElement.innerHTML = `
        <div class="${senderClass}">
            <img src="https://bootstrapious.com/i/snippets/sn-chat/avatar.svg" alt="user" width="50" class="rounded-circle">
            <div class="media-body ml-3">
                <div class="${bgClass} rounded py-2 px-3 mb-2">
                    <p class="text-small mb-0 ${textClass}">${data.message}</p>
                </div>
                <p class="small text-muted">${data.timestamp}</p>
            </div>
        </div>
    `;
    chatLog.appendChild(messageElement);
};

socket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
};

// Add event listener for sending messages
document.querySelector('#chat-form').addEventListener('submit', function(e) {
    e.preventDefault();  // Prevent the default form submission behavior
    const messageInputDom = document.querySelector('#chat-message-input');
    const message = messageInputDom.value.trim();  // Trim whitespace from the message
    if (message !== '') {  // Check if the message is not empty
        socket.send(JSON.stringify({
            'message': message,
            'sender': userId,
            'timestamp': new Date().toISOString()
        }));
        messageInputDom.value = '';  // Clear the input field after sending
    }
});

// Focus on the message input field
document.querySelector('#chat-message-input').focus();

  </script>
  
  
{% endblock %}
